# file: .github/workflows/release.yml
# version: 5.1.0
# guid: f1a2b3c4-d5e6-7f8a-9b0c-1d2e3f4a5b6c

name: Release Coordinator

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_call:
    inputs:
      release_type:
        required: false
        type: string
        default: auto
      build_target:
        required: false
        type: string
        default: all
      prerelease:
        required: false
        type: boolean
        default: false
      draft:
        required: false
        type: boolean
        default: false
    outputs:
      release-created:
        description: "Whether a release was created"
        value: ${{ jobs.release.outputs.release-created }}
      release-tag:
        description: "The release tag that was created"
        value: ${{ jobs.release.outputs.release-tag }}
      primary-language:
        description: "The primary language detected"
        value: ${{ jobs.release.outputs.primary-language }}
  workflow_dispatch:
    inputs:
      release_type:
        description: "Release type (auto, major, minor, patch)"
        required: false
        default: "auto"
        type: choice
        options:
          - auto
          - major
          - minor
          - patch
      build_target:
        description: "Build target"
        required: false
        default: "all"
        type: choice
        options:
          - all
          - go
          - python
          - frontend
          - docker
          - protobuf
          - rust
      prerelease:
        description: "Create as prerelease"
        required: false
        default: false
        type: boolean
      draft:
        description: "Create as draft"
        required: false
        default: false
        type: boolean

permissions:
  contents: write
  packages: write
  attestations: write
  id-token: write
  security-events: write

jobs:
  release:
    name: Ubuntu Autoinstall Agent Release
    uses: jdfalk/ghcommon/.github/workflows/reusable-release.yml@main
    with:
      release-type: ${{ inputs.release_type || 'auto' }}
      build-target: ${{ inputs.build_target || 'all' }}
      prerelease: ${{ inputs.prerelease || false }}
      draft: ${{ inputs.draft || false }}
    secrets: inherit
