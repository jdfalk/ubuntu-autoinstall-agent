# file: .github/workflows/release.yml
# version: 5.2.0
# guid: f1a2b3c4-d5e6-7f8a-9b0c-1d2e3f4a5b6c

name: Release Coordinator

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_call:
    inputs:
      release_type:
        description: "Release type (auto, major, minor, patch)"
        required: false
        type: string
        default: auto
      build_target:
        description: "Build target (all, go, python, frontend, docker, protobuf, rust)"
        required: false
        type: string
        default: all
      prerelease:
        required: false
        type: boolean
        default: false
      draft:
        required: false
        type: boolean
        default: false
      skip_language_detection:
        description: "Skip automatic language detection"
        required: false
        type: boolean
        default: false
      go_enabled:
        description: "Force enable Go builds"
        required: false
        type: boolean
        default: false
      python_enabled:
        description: "Force enable Python builds"
        required: false
        type: boolean
        default: false
      rust_enabled:
        description: "Force enable Rust builds"
        required: false
        type: boolean
        default: false
      frontend_enabled:
        description: "Force enable Frontend builds"
        required: false
        type: boolean
        default: false
      docker_enabled:
        description: "Force enable Docker builds"
        required: false
        type: boolean
        default: false
      protobuf_enabled:
        description: "Force enable Protobuf builds"
        required: false
        type: boolean
        default: false
    outputs:
      release-created:
        description: "Whether a release was created"
        value: ${{ jobs.release.outputs.release-created }}
      release-tag:
        description: "The release tag that was created"
        value: ${{ jobs.release.outputs.release-tag }}
      primary-language:
        description: "The primary language detected"
        value: ${{ jobs.release.outputs.primary-language }}
  workflow_dispatch:
    inputs:
      release_type:
        description: "Release type (auto, major, minor, patch)"
        required: false
        default: "auto"
        type: choice
        options:
          - auto
          - major
          - minor
          - patch
      build_target:
        description: "Build target"
        required: false
        default: "all"
        type: choice
        options:
          - all
          - go
          - python
          - frontend
          - docker
          - protobuf
          - rust
      prerelease:
        description: "Create as prerelease"
        required: false
        default: false
        type: boolean
      draft:
        description: "Create as draft"
        required: false
        default: false
        type: boolean
      skip_language_detection:
        description: "Skip automatic language detection"
        required: false
        default: false
        type: boolean
      go_enabled:
        description: "Force enable Go builds"
        required: false
        default: false
        type: boolean
      python_enabled:
        description: "Force enable Python builds"
        required: false
        default: false
        type: boolean
      rust_enabled:
        description: "Force enable Rust builds"
        required: false
        default: false
        type: boolean
      frontend_enabled:
        description: "Force enable Frontend builds"
        required: false
        default: false
        type: boolean
      docker_enabled:
        description: "Force enable Docker builds"
        required: false
        default: false
        type: boolean
      protobuf_enabled:
        description: "Force enable Protobuf builds"
        required: false
        default: false
        type: boolean

permissions:
  contents: write
  packages: write
  attestations: write
  id-token: write
  security-events: write

jobs:
  release:
    name: Ubuntu Autoinstall Agent Release
    uses: jdfalk/ghcommon/.github/workflows/reusable-release.yml@main
    with:
      release-type: ${{ inputs.release_type || 'auto' }}
      build-target: ${{ inputs.build_target || 'all' }}
      prerelease: ${{ inputs.prerelease || false }}
      draft: ${{ inputs.draft || false }}
      skip-language-detection: ${{ inputs.skip_language_detection || false }}
      go-enabled: ${{ inputs.go_enabled || false }}
      python-enabled: ${{ inputs.python_enabled || false }}
      rust-enabled: ${{ inputs.rust_enabled || false }}
      frontend-enabled: ${{ inputs.frontend_enabled || false }}
      docker-enabled: ${{ inputs.docker_enabled || false }}
      protobuf-enabled: ${{ inputs.protobuf_enabled || false }}
    secrets: inherit
